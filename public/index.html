<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My YT Music Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        input[type="range"] { accent-color: #dc2626; }
    </style>
</head>
<body class="bg-zinc-900 text-white font-sans overflow-hidden">

    <div class="flex h-screen">
        <aside class="w-64 bg-black p-6 hidden md:block">
            <h1 class="text-2xl font-bold mb-8 text-red-600 flex items-center">
                <i class="fab fa-youtube mr-2"></i> Moody Music
            </h1>
            <nav class="space-y-4 text-zinc-400">
                <a href="#" class="block hover:text-white transition"><i class="fas fa-home mr-3"></i> Home</a>
                <a href="#" class="block text-white transition font-semibold"><i class="fas fa-search mr-3"></i> Search</a>
                <a href="#" class="block hover:text-white transition"><i class="fas fa-list mr-3"></i> Library</a>
            </nav>
        </aside>

        <main class="flex-1 overflow-y-auto p-8 pb-32">
            <div class="mb-8 flex">
                <input id="searchInput" type="text" placeholder="Cari lagu atau artis..." 
                    class="w-full max-w-md bg-zinc-800 border-none rounded-l-full py-2 px-6 focus:ring-1 focus:ring-red-600 outline-none">
                <button onclick="searchMusic()" class="bg-red-600 px-6 py-2 rounded-r-full hover:bg-red-700 transition">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div id="results" class="grid grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <div class="text-zinc-500 col-span-full text-center mt-20">
                    <i class="fas fa-music text-4xl mb-4"></i>
                    <p>Cari lagu untuk memulai pemutaran</p>
                </div>
            </div>
        </main>
    </div>

    <footer class="fixed bottom-0 w-full bg-zinc-950 border-t border-zinc-800 p-4">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            
            <div class="flex items-center space-x-4 w-1/4">
                <img id="currentThumb" src="https://via.placeholder.com/150" class="w-14 h-14 rounded shadow-lg object-cover">
                <div class="overflow-hidden">
                    <p id="currentTitle" class="font-semibold text-sm truncate">Pilih Lagu...</p>
                    <p id="currentArtist" class="text-xs text-zinc-400 truncate">Artis</p>
                </div>
            </div>
            
            <div class="flex flex-col items-center w-2/4">
		<div class="flex items-center space-x-6 mb-2">
		    <button id="shuffleBtn" onclick="toggleShuffle()" class="text-zinc-400 hover:text-white transition">
			<i class="fas fa-random"></i>
		    </button>

		    <button onclick="prevSong()" class="text-xl hover:text-red-500 transition"><i class="fas fa-step-backward"></i></button>
		    
		    <button id="masterPlay" onclick="togglePlay()" class="bg-white text-black w-10 h-10 rounded-full flex items-center justify-center hover:scale-105 transition">
			<i id="playIcon" class="fas fa-play ml-1"></i>
		    </button>

		    <button onclick="nextSong()" class="text-xl hover:text-red-500 transition"><i class="fas fa-step-forward"></i></button>
		    
		    <button id="repeatBtn" onclick="toggleRepeat()" class="text-zinc-400 hover:text-white transition">
			<i class="fas fa-redo"></i>
		    </button>
		</div>		            
                <div class="flex items-center space-x-3 w-full max-w-lg">
                    <span id="currTime" class="text-[10px] text-zinc-500 w-8 text-right">0:00</span>
                    <input type="range" id="progressBar" value="0" class="flex-1 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
                    <span id="durTime" class="text-[10px] text-zinc-500 w-8">0:00</span>
                </div>
            </div>

            <div class="flex items-center justify-end space-x-3 w-1/4">
                <i class="fas fa-volume-down text-zinc-400"></i>
                <input type="range" id="volSlider" min="0" max="1" step="0.1" value="1" class="w-24 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
    </footer>
    
    <audio id="audioElement"></audio>

    <script>
        const audio = document.getElementById('audioElement');
        const playIcon = document.getElementById('playIcon');
        const progressBar = document.getElementById('progressBar');
        const currTimeLabel = document.getElementById('currTime');
        const durTimeLabel = document.getElementById('durTime');
        const volSlider = document.getElementById('volSlider');

        async function searchMusic() {
            const query = document.getElementById('searchInput').value;
            if(!query) return;

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p class="col-span-full text-center">Mencari...</p>';

            try {
                const res = await fetch(`/api/search?q=${query}`);
                const data = await res.json();
                
                resultsDiv.innerHTML = data.map(song => `
                    <div class="bg-zinc-800/50 p-4 rounded-lg hover:bg-zinc-800 transition cursor-pointer group" 
                         onclick="playSong('${song.videoId}', '${song.name.replace(/'/g, "\\'")}', '${song.artist.name.replace(/'/g, "\\'")}', '${song.thumbnails[0].url}')">
                        <div class="relative mb-4">
                            <img src="${song.thumbnails[0].url}" class="w-full aspect-square object-cover rounded shadow-md">
                            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <div class="bg-red-600 p-3 rounded-full shadow-xl">
                                    <i class="fas fa-play text-white"></i>
                                </div>
                            </div>
                        </div>
                        <h3 class="font-bold truncate text-sm">${song.name}</h3>
                        <p class="text-xs text-zinc-400 mt-1">${song.artist.name}</p>
                    </div>
                `).join('');
            } catch (err) {
                resultsDiv.innerHTML = '<p class="col-span-full text-center text-red-500">Gagal memuat data.</p>';
            }
        }

        async function playSong(id, title, artist, thumb) {
            // Update UI
            document.getElementById('currentTitle').innerText = title;
            document.getElementById('currentArtist').innerText = artist;
            document.getElementById('currentThumb').src = thumb;

		try {
			const response = await fetch(`/api/stream?id=${id}`);
			const data = await response.json();

			if (data.url) {
			    audio.src = data.url;
			    audio.play();
			    playIcon.className = 'fas fa-pause';
			} else {
			    alert("Lagu ini tidak dapat diputar (Error Decipher)");
			}
		    } catch (err) {
			console.error("Fetch error:", err);
		    } 
        }

        function togglePlay() {
            if (!audio.src) return;
            if (audio.paused) {
                audio.play();
                playIcon.className = 'fas fa-pause';
            } else {
                audio.pause();
                playIcon.className = 'fas fa-play ml-1';
            }
        }

        // Logic Progress Bar
        audio.ontimeupdate = () => {
            const progress = (audio.currentTime / audio.duration) * 100;
            progressBar.value = progress || 0;
            
            currTimeLabel.innerText = formatTime(audio.currentTime);
            durTimeLabel.innerText = isNaN(audio.duration) ? "0:00" : formatTime(audio.duration);
        };

        progressBar.oninput = () => {
            const seekTime = (progressBar.value / 100) * audio.duration;
            audio.currentTime = seekTime;
        };

        volSlider.oninput = (e) => {
            audio.volume = e.target.value;
        };

        function formatTime(secs) {
            const mins = Math.floor(secs / 60);
            const s = Math.floor(secs % 60);
            return `${mins}:${s < 10 ? '0' : ''}${s}`;
        }
	document.getElementById('searchInput').addEventListener('keypress', function (e) {
	    if (e.key === 'Enter') {
		searchMusic();
	    }
	});        
	
	
	let songQueue = []; // Menyimpan daftar lagu dari hasil pencarian
	let currentSongIndex = -1; // Indeks lagu yang sedang diputar

	// Update fungsi searchMusic agar mengisi queue
	async function searchMusic() {
	    const query = document.getElementById('searchInput').value;
	    if(!query) return;

	    try {
		const res = await fetch(`/api/search?q=${query}`);
		const data = await res.json();
		
		// SIMPAN HASIL KE QUEUE
		songQueue = data; 
		
		const resultsDiv = document.getElementById('results');
		resultsDiv.innerHTML = data.map((song, index) => `
		    <div class="bg-zinc-800/50 p-4 rounded-lg hover:bg-zinc-800 transition cursor-pointer group" 
		         onclick="playSongByIndex(${index})">
		        <div class="relative mb-4">
		            <img src="${song.thumbnails[0].url}" class="w-full aspect-square object-cover rounded shadow-md">
		            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
		                <div class="bg-red-600 p-3 rounded-full shadow-xl">
		                    <i class="fas fa-play text-white"></i>
		                </div>
		            </div>
		        </div>
		        <h3 class="font-bold truncate text-sm">${song.name}</h3>
		        <p class="text-xs text-zinc-400 mt-1">${song.artist.name}</p>
		    </div>
		`).join('');
	    } catch (err) {
		console.error("Search failed", err);
	    }
	}

	// Fungsi baru untuk memutar berdasarkan indeks antrean
	async function playSongByIndex(index) {
	    if (index < 0 || index >= songQueue.length) return;
	    
	    currentSongIndex = index;
	    const song = songQueue[index];
	    
	    // Panggil fungsi playSong utama (sesuaikan dengan parameter yang ada)
	    // Jika Anda menggunakan metode URL langsung:
	    playSong(song.videoId, song.name, song.artist.name, song.thumbnails[0].url);
	}

	// Fungsi kontrol Next dan Previous
	function nextSong() {
	    if (currentSongIndex < songQueue.length - 1) {
		playSongByIndex(currentSongIndex + 1);
	    }
	}

	function prevSong() {
	    if (currentSongIndex > 0) {
		playSongByIndex(currentSongIndex - 1);
	    }
	}

	// Tambahkan event agar otomatis putar lagu berikutnya saat lagu habis
	audio.onended = () => {
	    nextSong();
	};
	
	let isShuffle = false;
	let isRepeat = false;

	function toggleShuffle() {
	    isShuffle = !isShuffle;
	    document.getElementById('shuffleBtn').classList.toggle('text-red-500', isShuffle);
	    document.getElementById('shuffleBtn').classList.toggle('text-zinc-400', !isShuffle);
	}

	function toggleRepeat() {
	    isRepeat = !isRepeat;
	    document.getElementById('repeatBtn').classList.toggle('text-red-500', isRepeat);
	    document.getElementById('repeatBtn').classList.toggle('text-zinc-400', !isRepeat);
	}

	// Modifikasi fungsi NextSong untuk mendukung Shuffle & Repeat
	function nextSong() {
	    if (isRepeat) {
		// Jika repeat aktif, putar lagu yang sama lagi
		playSongByIndex(currentSongIndex);
	    } else if (isShuffle) {
		// Jika shuffle aktif, pilih indeks secara acak
		let randomIndex = Math.floor(Math.random() * songQueue.length);
		playSongByIndex(randomIndex);
	    } else {
		// Normal: lanjut ke lagu berikutnya
		if (currentSongIndex < songQueue.length - 1) {
		    playSongByIndex(currentSongIndex + 1);
		}
	    } 
	}
	
	window.addEventListener('keydown', function(e) {
	    if (e.code === "Space" && e.target.tagName !== 'INPUT') {
		e.preventDefault(); // Mencegah halaman scroll ke bawah saat tekan Space
		togglePlay();
	    }
	});
    </script>
</body>
</html>
